/*
################################################################################
#  THIS FILE IS 100% GENERATED BY ZPROJECT; DO NOT EDIT EXCEPT EXPERIMENTALLY  #
#  Read the zproject/README.md for information about making permanent changes. #
################################################################################
*/

dependencies {
    implementation project(':zyre-jni')
    runtimeOnly "org.zeromq.czmq:czmq-jni-${osdetector.classifier}:latest.release"
}

//  ------------------------------------------------------------------
//  Build section

task copyLibs(type: Copy) {
    def libraryPaths = []
    if (project.hasProperty('buildPrefix')) {
        if (osdetector.os == 'windows') {
            // DLLs are installed to the bin directory by cmake
            libraryPaths.add("${project.buildPrefix}/bin")
        }
        libraryPaths.add("${project.buildPrefix}/lib")
    }

    def javaLibraryPaths = System.getProperty('java.library.path').split(File.pathSeparator).toList()
    libraryPaths.addAll (javaLibraryPaths)

    libraryPaths.add('/usr/local/lib')
    if (osdetector.os == 'windows') {
        libraryPaths.add("${rootDir}/zyre-jni/build/Release")
    } else {
        libraryPaths.add("${rootDir}/zyre-jni/build")
    }

    def oldStrategy = duplicatesStrategy
    duplicatesStrategy = DuplicatesStrategy.WARN
    libraryPaths.each { path ->
        from path
            include 'libzyrejni.so'
            include 'libzyrejni.dylib'
            include '*zyrejni*.dll'
            include 'libzyre.so'
            include 'libzyre.dylib'
            include '*zyre*.dll'
            include 'libzmq.so'
            include 'libzmq.dylib'
            include '*zmq*.dll'
            include 'libczmq.so'
            include 'libczmq.dylib'
            include '*czmq*.dll'
        into 'build/natives'
    }
    duplicatesStrategy = oldStrategy
}

jar.baseName = "zyre-jni-${osdetector.classifier}"
jar.dependsOn copyLibs

jar {
    def arch = osdetector.arch.contains('64') ? '64' : '32'
    from 'build/natives'
        include '*'
    into "natives/${osdetector.os}_${arch}"
}

//  ------------------------------------------------------------------
//  Install and Publish section

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            artifactId = "zyre-jni-${osdetector.classifier}"
            pom {
                name = "zyre-jni-${osdetector.classifier}"
                description = 'an open-source framework for proximity-based P2P apps'
                packaging = 'jar'
                url = 'https://github.com/zeromq/zyre'
                licenses {
                    license {
                        name = 'Mozilla Public License Version 2.0'
                        url = 'https://www.mozilla.org/en-US/MPL/2.0/'
                    }
                }
                scm {
                    connection = 'https://github.com/zeromq/zyre.git'
                    developerConnection = 'https://github.com/zeromq/zyre.git'
                    url = 'https://github.com/zeromq/zyre'
                }
            }
        }
    }
}

artifactoryPublish {
    publications ('mavenJava')
}

bintray {
    user = System.getenv('BINTRAY_USER')
    key = System.getenv('BINTRAY_KEY')
    publications = ['mavenJava']
    publish = true
    override = true
    pkg {
        repo = 'maven'
        name = "zyre-jni-${osdetector.classifier}"
        desc = 'an open-source framework for proximity-based P2P apps'
        userOrg = System.getenv('BINTRAY_USER_ORG')
        licenses = ['MPL-2.0']
        websiteUrl = 'https://github.com/zeromq/zyre'
        issueTrackerUrl = 'https://github.com/zeromq/zyre/issues'
        vcsUrl = 'https://github.com/zeromq/zyre.git'
        githubRepo = System.getenv('BINTRAY_USER_ORG') + '/zyre'
        version {
            name = project.version
            vcsTag= project.version
        }
    }
}

//  ------------------------------------------------------------------
//  Cleanup section

clean.doFirst {
    delete fileTree(projectDir) {
        include '*.so'
        include '*.dylib'
    }
}
